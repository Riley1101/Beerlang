#!/usr/bin/env bun
// @bun
var jO=function(){const O=new Map;for(let[$,Q]of Object.entries(G)){for(let[W,H]of Object.entries(Q))G[W]={open:`\x1B[${H[0]}m`,close:`\x1B[${H[1]}m`},Q[W]=G[W],O.set(H[0],H[1]);Object.defineProperty(G,$,{value:Q,enumerable:!1})}return Object.defineProperty(G,"codes",{value:O,enumerable:!1}),G.color.close="\x1B[39m",G.bgColor.close="\x1B[49m",G.color.ansi=KO(),G.color.ansi256=XO(),G.color.ansi16m=ZO(),G.bgColor.ansi=KO(10),G.bgColor.ansi256=XO(10),G.bgColor.ansi16m=ZO(10),Object.defineProperties(G,{rgbToAnsi256:{value($,Q,W){if($===Q&&Q===W){if($<8)return 16;if($>248)return 231;return Math.round(($-8)/247*24)+232}return 16+36*Math.round($/255*5)+6*Math.round(Q/255*5)+Math.round(W/255*5)},enumerable:!1},hexToRgb:{value($){const Q=/[a-f\d]{6}|[a-f\d]{3}/i.exec($.toString(16));if(!Q)return[0,0,0];let[W]=Q;if(W.length===3)W=[...W].map((J)=>J+J).join("");const H=Number.parseInt(W,16);return[H>>16&255,H>>8&255,H&255]},enumerable:!1},hexToAnsi256:{value:($)=>G.rgbToAnsi256(...G.hexToRgb($)),enumerable:!1},ansi256ToAnsi:{value($){if($<8)return 30+$;if($<16)return 90+($-8);let Q,W,H;if($>=232)Q=(($-232)*10+8)/255,W=Q,H=Q;else{$-=16;const JO=$%36;Q=Math.floor($/36)/5,W=Math.floor(JO/6)/5,H=JO%6/5}const J=Math.max(Q,W,H)*2;if(J===0)return 30;let K=30+(Math.round(H)<<2|Math.round(W)<<1|Math.round(Q));if(J===2)K+=60;return K},enumerable:!1},rgbToAnsi:{value:($,Q,W)=>G.ansi256ToAnsi(G.rgbToAnsi256($,Q,W)),enumerable:!1},hexToAnsi:{value:($)=>G.ansi256ToAnsi(G.hexToAnsi256($)),enumerable:!1}}),G};var KO=(O=0)=>($)=>`\x1B[${$+O}m`,XO=(O=0)=>($)=>`\x1B[${38+O};5;${$}m`,ZO=(O=0)=>($,Q,W)=>`\x1B[${38+O};2;${$};${Q};${W}m`,G={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],gray:[90,39],grey:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgGray:[100,49],bgGrey:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}},gO=Object.keys(G.modifier),FO=Object.keys(G.color),SO=Object.keys(G.bgColor),cO=[...FO,...SO],BO=jO(),X=BO;var C=(()=>{if(navigator.userAgentData){const O=navigator.userAgentData.brands.find(({brand:$})=>$==="Chromium");if(O&&O.version>93)return 3}if(/\b(Chrome|Chromium)\//.test(navigator.userAgent))return 1;return 0})(),PO=C!==0&&{level:C,hasBasic:!0,has256:C>=2,has16m:C>=3},_O={stdout:PO,stderr:PO},LO=_O;function wO(O,$,Q){let W=O.indexOf($);if(W===-1)return O;const H=$.length;let J=0,K="";do K+=O.slice(J,W)+$+Q,J=W+H,W=O.indexOf($,J);while(W!==-1);return K+=O.slice(J),K}function VO(O,$,Q,W){let H=0,J="";do{const K=O[W-1]==="\r";J+=O.slice(H,K?W-1:W)+$+(K?"\r\n":"\n")+Q,H=W+1,W=O.indexOf("\n",H)}while(W!==-1);return J+=O.slice(H),J}var _=function(O){return CO(O)};var{stdout:MO,stderr:NO}=LO,c=Symbol("GENERATOR"),z=Symbol("STYLER"),B=Symbol("IS_EMPTY"),YO=["ansi","ansi","ansi256","ansi16m"],A=Object.create(null),fO=(O,$={})=>{if($.level&&!(Number.isInteger($.level)&&$.level>=0&&$.level<=3))throw new Error("The `level` option should be an integer from 0 to 3");const Q=MO?MO.level:0;O.level=$.level===void 0?Q:$.level};var CO=(O)=>{const $=(...Q)=>Q.join(" ");return fO($,O),Object.setPrototypeOf($,_.prototype),$};Object.setPrototypeOf(_.prototype,Function.prototype);for(let[O,$]of Object.entries(X))A[O]={get(){const Q=R(this,k($.open,$.close,this[z]),this[B]);return Object.defineProperty(this,O,{value:Q}),Q}};A.visible={get(){const O=R(this,this[z],!0);return Object.defineProperty(this,"visible",{value:O}),O}};var x=(O,$,Q,...W)=>{if(O==="rgb"){if($==="ansi16m")return X[Q].ansi16m(...W);if($==="ansi256")return X[Q].ansi256(X.rgbToAnsi256(...W));return X[Q].ansi(X.rgbToAnsi(...W))}if(O==="hex")return x("rgb",$,Q,...X.hexToRgb(...W));return X[Q][O](...W)},RO=["rgb","hex","ansi256"];for(let O of RO){A[O]={get(){const{level:Q}=this;return function(...W){const H=k(x(O,YO[Q],"color",...W),X.color.close,this[z]);return R(this,H,this[B])}}};const $="bg"+O[0].toUpperCase()+O.slice(1);A[$]={get(){const{level:Q}=this;return function(...W){const H=k(x(O,YO[Q],"bgColor",...W),X.bgColor.close,this[z]);return R(this,H,this[B])}}}}var hO=Object.defineProperties(()=>{},{...A,level:{enumerable:!0,get(){return this[c].level},set(O){this[c].level=O}}}),k=(O,$,Q)=>{let W,H;if(Q===void 0)W=O,H=$;else W=Q.openAll+O,H=$+Q.closeAll;return{open:O,close:$,openAll:W,closeAll:H,parent:Q}},R=(O,$,Q)=>{const W=(...H)=>bO(W,H.length===1?""+H[0]:H.join(" "));return Object.setPrototypeOf(W,hO),W[c]=O,W[z]=$,W[B]=Q,W},bO=(O,$)=>{if(O.level<=0||!$)return O[B]?"":$;let Q=O[z];if(Q===void 0)return $;const{openAll:W,closeAll:H}=Q;if($.includes("\x1B"))while(Q!==void 0)$=wO($,Q.close,Q.open),Q=Q.parent;const J=$.indexOf("\n");if(J!==-1)$=VO($,H,W,J);return W+$+H};Object.defineProperties(_.prototype,A);var vO=_(),lO=_({level:NO?NO.level:0});var L=vO;function IO(O){const Q=Bun.argv[2];if(Q===void 0)console.log("Usage: beer [script]"),process.exit(64);const W=Bun.file(Q);if(!/(\.beer)$/g.test(W.name))console.log("File must have .beer extension"),process.exit(64);W.text().then((K)=>{O(K)})}var E=L;class m{_log;constructor(){this._log=E}info(O){if(typeof O==="object")O=JSON.stringify(O,null,2);console.log(this._log.blue(O))}error(O){if(typeof O==="object")O=JSON.stringify(O,null,2);console.log(this._log.red(O))}warn(O){if(typeof O==="object")O=JSON.stringify(O,null,2);console.log(this._log.yellow(O))}debug(O){if(typeof O==="object")O=JSON.stringify(O,null,2);console.log(this._log.green(O))}}class y extends Error{constructor(O){super(O);this.name="ClientError"}}class P extends Error{token;constructor(O,$){super($);this.token=O,this.name="RuntimeError"}}class Z extends Error{token;constructor(O,$){super($);this.token=O,this.name="SyntaxError"}}class zO{hasCliError=!1;hasRuntimeError=!1;hasSyntaxError=!1;log(O){if(O instanceof y)console.log(E.red(O.message));else if(O instanceof P)console.log(E.red(O.message));else console.log(E.red(O.message))}report(O){if(O instanceof y)this.hasCliError=!0;else if(O instanceof P)this.hasRuntimeError=!0;else this.hasSyntaxError=!0;throw this.log(O),O}}var q=new zO;class f{O;constructor(O){this.statements=O;this.statements=O}accept(O){return O.visitBlockStmt(this)}}class h{O;constructor(O){this.expression=O;this.expression=O}accept(O){return O.visitExpressionStmt(this)}}class i{O;constructor(O){this.expression=O;this.expression=O}accept(O){return O.visitPrintStmt(this)}}class a{O;$;Q;constructor(O,$,Q){this.condition=O;this.thenBranch=$;this.elseBranch=Q;this.condition=O,this.thenBranch=$,this.elseBranch=Q}accept(O){return O.visitIfStmt(this)}}class b{O;$;constructor(O,$){this.condition=O;this.body=$;this.condition=O,this.body=$}accept(O){return O.visitWhileStmt(this)}}class l{O;$;constructor(O,$){this.keyword=O;this.value=$;this.keyword=O,this.value=$}accept(O){return O.visitReturnStmt(this)}}class T{O;$;Q;constructor(O,$,Q){this.name=O;this.params=$;this.body=Q;this.name=O,this.params=$,this.body=Q}accept(O){return O.visitFunctionStmt(this)}}class p{O;$;constructor(O,$){this.keyword=O;this.method=$;this.keyword=O,this.method=$}accept(O){return O.visitSuperExpr(this)}}class o{O;$;Q;constructor(O,$,Q){this.name=O;this.superclass=$;this.methods=Q;this.name=O,this.superclass=$,this.methods=Q}accept(O){return O.visitClassStmt(this)}}class s{O;$;constructor(O,$){this.name=O;this.initializer=$;this.name=O,this.initializer=$}accept(O){return O.visitVarStmt(this)}}class n{O;$;Q;constructor(O,$,Q){this.object=O;this.name=$;this.value=Q;this.object=O,this.name=$,this.value=Q}accept(O){return O.visitSetExpr(this)}}class r{O;constructor(O){this.keyword=O;this.keyword=O}accept(O){return O.visitThisExpr(this)}}class v{O;$;constructor(O,$){this.object=O;this.name=$;this.object=O,this.name=$}accept(O){return O.visitGetExpr(this)}}class F{left;operator;right;constructor(O,$,Q){this.left=O,this.operator=$,this.right=Q}accept(O){return O.visitBinaryExpr(this)}}class t{operator;right;constructor(O,$){this.operator=O,this.right=$}accept(O){return O.visitUnaryExpr(this)}}class N{value;constructor(O){this.value=O}accept(O){return O.visitLiteralExpr(this)}}class e{expression;constructor(O){this.expression=O}accept(O){return O.visitGroupingExpr(this)}}class S{O;constructor(O){this.name=O;this.name=O}accept(O){return O.visitVariableExpr(this)}}class OO{O;$;constructor(O,$){this.name=O;this.value=$;this.name=O,this.value=$}accept(O){return O.visitAssignExpr(this)}}class $O{O;$;Q;constructor(O,$,Q){this.callee=O;this.paren=$;this.args=Q;this.callee=O,this.paren=$,this.args=Q}accept(O){return O.visitCallExpr(this)}}class u{O;$;Q;constructor(O,$,Q){this.left=O;this.operator=$;this.right=Q;this.left=O,this.operator=$,this.right=Q}accept(O){return O.visitLogicalExpr(this)}}class QO{visitSetExpr(O){return this.parenthesize(`set ${O.name.lexeme}`,O.value)}visitGetExpr(O){return this.parenthesize(`get ${O.name.lexeme}`,O.object)}visitAssignExpr(O){return this.parenthesize(O.name.lexeme,O.value)}visitBinaryExpr(O){return this.parenthesize(O.operator.lexeme,O.left,O.right)}visitUnaryExpr(O){return this.parenthesize(O.operator.lexeme,O.right)}visitLiteralExpr(O){if(O.value===null)return"nil";return O.value.toString()}visitLogicalExpr(O){return this.parenthesize(O.operator.lexeme,O.left,O.right)}visitExpressionStmt(O){return this.parenthesize("expression",O.expression)}visitPrintStmt(O){return this.parenthesize("print",O.expression)}visitVarStmt(O){const $=new S(O.name);if(O.initializer)return this.parenthesize("var",$,O.initializer);return this.parenthesize("var",$)}visitBlockStmt(O){let $="(block ";for(let Q of O.statements)$+="\n"+this.indent(Q.accept(this));return $+=")",$}visitForStmt(O){let $=`(for ${this.stringify(O.initializer)} ${this.stringify(O.condition)} ${this.stringify(O.increment)}\n`;const Q=this.stringify(O.body);return $+=this.indent(Q),$+=")",$}visitWhileStmt(O){let $=`(while ${this.stringify(O.condition)}\n`;const Q=this.stringify(O.body);return $+=this.indent(Q),$+=")",$}visitReturnStmt(O){if(O.value)return this.parenthesize("return",O.value);return this.parenthesize("return")}visitFunctionStmt(O){let $=`(fun ${O.name.lexeme} (`;for(let W of O.params)$+=W.lexeme+" ";$+=")\n";const Q=this.stringify(O.body);return $+=this.indent(Q),$+=")",$}visitClassStmt(O){let $=`(class ${O.name.lexeme}`;return O.methods.forEach((Q)=>{$+="\n"+this.indent(this.stringify(Q))}),$+=")",$}visitIfStmt(O){let $=`(if ${this.stringify(O.condition)}\n`;const Q=this.stringify(O.thenBranch);if($+=this.indent(Q),O.elseBranch!==null){$+="\n";const W=this.stringify(O.elseBranch);$+=this.indent(W)}return $+=")",$}visitVariableExpr(O){return O.name.lexeme}visitGroupingExpr(O){return this.parenthesize("group",O.expression)}visitThisExpr(O){return O.keyword.lexeme}visitCallExpr(O){return this.parenthesize("call",O.callee,...O.args)}visitSuperExpr(O){return O.keyword.lexeme}parenthesize(O,...$){let Q=`(${O}`;for(let W of $)Q+=` ${W.accept(this)}`;return Q+=")",Q}indent(O){return O.split("\n").map(($)=>`  ${$}`).join("\n")}print(O){return O.accept(this)}stringify(O){if(O===null)return"nil";if(O instanceof Array)return O.map(($)=>$.accept(this)).join("\n");else return O.accept(this)}print_ast(O){console.log(E.cyan(this.stringify(O)))}}class w{enclosing;values=new Map;constructor(O){if(this.enclosing=null,O)this.enclosing=O}define(O,$){this.values.set(O,$)}get(O){if(this.values.has(O))return this.values.get(O);if(this.enclosing!==null)return this.enclosing.get(O);return q.report(new ReferenceError(`Undefined variable '${O}'`))}assign(O,$){if(this.values.has(O)){this.values.set(O,$);return}if(this.enclosing!==null){this.enclosing.assign(O,$);return}return q.report(new ReferenceError(`Undefined variable '${O}'`))}ancestor(O){let $=this;for(let Q=0;Q<O;Q++)$=$.enclosing;return $}get_at(O,$){return this.ancestor(O).values.get($)}assign_at(O,$,Q){this.ancestor(O).values.set($,Q)}}var U;(function(D){D["LEFT_PAREN"]="LEFT_PAREN";D["RIGHT_PAREN"]="RIGHT_PAREN";D["LEFT_BRACE"]="LEFT_BRACE";D["RIGHT_BRACE"]="RIGHT_BRACE";D["LEFT_BRACKET"]="LEFT_BRACKET";D["RIGHT_BRACKET"]="RIGHT_BRACKET";D["COMMA"]="COMMA";D["DOT"]="DOT";D["MINUS"]="MINUS";D["PLUS"]="PLUS";D["MODULO"]="MODULO";D["SEMICOLON"]="SEMICOLON";D["SLASH"]="SLASH";D["STAR"]="STAR";D["BANG"]="BANG";D["BANG_EQUAL"]="BANG_EQUAL";D["EQUAL"]="EQUAL";D["EQUAL_EQUAL"]="EQUAL_EQUAL";D["GREATER"]="GREATER";D["GREATER_EQUAL"]="GREATER_EQUAL";D["LESS"]="LESS";D["LESS_EQUAL"]="LESS_EQUAL";D["IDENTIFIER"]="IDENTIFIER";D["STRING"]="STRING";D["NUMBER"]="NUMBER";D["AND"]="AND";D["CLASS"]="CLASS";D["ELSE"]="ELSE";D["FALSE"]="FALSE";D["FUN"]="FUN";D["FOR"]="FOR";D["IF"]="IF";D["NIL"]="NIL";D["OR"]="OR";D["PRINT"]="PRINT";D["RETURN"]="RETURN";D["SUPER"]="SUPER";D["THIS"]="THIS";D["TRUE"]="TRUE";D["VAR"]="VAR";D["WHILE"]="WHILE";D["EOF"]="EOF"})(U||(U={}));var AO={and:U.AND,class:U.CLASS,else:U.ELSE,false:U.FALSE,for:U.FOR,fun:U.FUN,if:U.IF,nil:U.NIL,or:U.OR,print:U.PRINT,return:U.RETURN,super:U.SUPER,this:U.THIS,true:U.TRUE,var:U.VAR,while:U.WHILE};class I{}class Y extends I{O;$;Q;static Return=class O{value;constructor($){this.value=$}};constructor(O,$,Q=!1){super();this.declaration=O;this.closure=$;this.is_initializer=Q;this.declaration=O,this.closure=$,this.is_initializer=Q}to_string(){return`<fun ${this.declaration.name.lexeme}>`}arity(){return this.declaration.params.length}bind(O){let $=new w(this.closure);return $.define("this",O),new Y(this.declaration,$,this.is_initializer)}call(O,$){const Q=new w(this.closure);for(let W=0;W<this.declaration.params.length;W++)Q.define(this.declaration.params[W].lexeme,$[W]);try{O.execute_block(this.declaration.body,Q)}catch(W){if(W instanceof Y.Return){if(this.is_initializer)return this.closure.get_at(0,"this");return W.value}throw W}if(this.is_initializer)return this.closure.get_at(0,"this");return null}}class UO extends I{constructor(){super(...arguments)}arity(){return 0}call(){return Date.now().valueOf()/1000}to_string(){return"<native fn>"}}class d extends I{$;Q;name;constructor(O,$,Q){super();this.methods=$;this.superclass=Q;this.name=O,this.methods=$,this.superclass=Q}find_method(O){if(this.methods.has(O))return this.methods.get(O);if(this.superclass!==null)return this.superclass.find_method(O);return null}arity(){const O=this.find_method("init");if(O===null)return 0;return O.arity()}call(O,$){let Q=new j(this);const W=this.find_method("init");if(W!==null)W.bind(Q).call(O,$);return Q}to_string(){return`<class ${this.name}>`}}class j{O;fields=new Map;constructor(O){this.klass=O;this.klass=O}get(O){if(this.fields.has(O.lexeme))return this.fields.get(O.lexeme);let $=this.klass.find_method(O.lexeme);if($)return $.bind(this);return q.report(new SyntaxError(`Undefined property '${O.lexeme}'.`))}set(O,$){this.fields.set(O.lexeme,$)}to_string(){return`<instance ${this.klass.name}>`}}class WO{globals=new w;environment=this.globals;locals=new Map;constructor(){this.globals.define("clock",new UO)}resolve(O,$){this.locals.set(O,$)}look_up_variable(O,$){const Q=this.locals.get($);if(Q!==void 0)return this.environment.get_at(Q,O.lexeme);else return this.globals.get(O.lexeme)}interpret(O){try{for(let $ of O)this.execute($)}catch($){throw $}}execute(O){O.accept(this)}evaluate(O){return O.accept(this)}is_equal(O,$){if(O===null&&$===null)return!0;if(O===null)return!1;return O===$}checkNumberOperands(O,$,Q){if(typeof $==="number"&&typeof Q==="number")return;else q.report(new SyntaxError("Operands must be numbers at "+O.line+O.lexeme))}is_truthy(O){if(O===null)return!1;if(typeof O==="boolean")return O;return!0}stringify(O){if(O===null)return"nil";if(typeof O==="number")return O.toString();if(O instanceof I)return O.to_string();if(O instanceof j)return O.to_string();return O.toString()}execute_block(O,$){const Q=this.environment;try{this.environment=$;for(let W of O)W&&this.execute(W)}finally{this.environment=Q}}visitThisExpr(O){return this.look_up_variable(O.keyword,O)}visitAssignExpr(O){let $=this.evaluate(O.value),Q=this.locals.get(O);if(Q!==void 0)this.environment.assign_at(Q,O.name.lexeme,$);else this.globals.assign(O.name.lexeme,$);return $}visitBinaryExpr(O){let $=this.evaluate(O.left),Q=this.evaluate(O.right);switch(O.operator.type){case U.GREATER:return this.checkNumberOperands(O.operator,$,Q),$>Q;case U.GREATER_EQUAL:return this.checkNumberOperands(O.operator,$,Q),$>=Q;case U.LESS:return this.checkNumberOperands(O.operator,$,Q),$<Q;case U.LESS_EQUAL:return this.checkNumberOperands(O.operator,$,Q),$<=Q;case U.MINUS:return this.checkNumberOperands(O.operator,$,Q),$-Q;case U.BANG_EQUAL:return!this.is_equal($,Q);case U.EQUAL_EQUAL:return this.is_equal($,Q);case U.SLASH:return this.checkNumberOperands(O.operator,$,Q),$/Q;case U.STAR:return this.checkNumberOperands(O.operator,$,Q),$*Q;case U.PLUS:if(typeof $==="number"&&typeof Q==="number")return $+Q;if(typeof $==="string"&&typeof Q==="string")return $+Q;q.report(new SyntaxError("Operands must be two numbers or two strings at "+O.operator.line+O.operator.lexeme))}return null}visitUnaryExpr(O){let $=this.evaluate(O.right);switch(O.operator.type){case U.MINUS:return-$;case U.BANG:return!this.is_truthy($)}return null}visitLiteralExpr(O){return O.value}visitGroupingExpr(O){return this.evaluate(O.expression)}visitVariableExpr(O){return this.look_up_variable(O.name,O)}visitLogicalExpr(O){let $=this.evaluate(O.left);if(O.operator.type===U.OR){if(this.is_truthy($))return $}else if(!this.is_truthy($))return $;return this.evaluate(O.right)}visitCallExpr(O){let $=this.evaluate(O.callee),Q=[];for(let H of O.args)Q.push(this.evaluate(H));if(!($ instanceof I))throw q.report(new SyntaxError("Can only call functions and classes."));if(Q.length!==$.arity())throw q.report(new SyntaxError(`Expected ${$.arity()} arguments but got ${Q.length}.`));return $.call(this,Q)}visitClassStmt(O){let $=null;if(O.superclass!==null){if($=this.evaluate(O.superclass),!($ instanceof d))throw q.report(new SyntaxError("Superclass must be a class."))}if(this.environment.define(O.name.lexeme,null),O.superclass!==null)this.environment=new w(this.environment),this.environment.define("super",$);let Q=new Map;for(let H of O.methods){let J=new Y(H,this.environment,H.name.lexeme==="init");Q.set(H.name.lexeme,J)}let W=new d(O.name.lexeme,Q,$);if($!==null)this.environment=this.environment.enclosing;this.environment.assign(O.name.lexeme,W)}visitForStmt(O){if(O.initializer)this.execute(O.initializer);while(this.is_truthy(this.evaluate(O.condition))){if(this.execute(O.body),O.increment===null)return;this.evaluate(O.increment)}}visitWhileStmt(O){while(this.is_truthy(this.evaluate(O.condition)))this.execute(O.body)}visitReturnStmt(O){let $=null;if(O.value!==null)$=this.evaluate(O.value);throw new Y.Return($)}visitFunctionStmt(O){let $=new Y(O,this.environment,!1);this.environment.define(O.name.lexeme,$);return}visitPrintStmt(O){let $=this.evaluate(O.expression);console.log(this.stringify($))}visitExpressionStmt(O){this.evaluate(O.expression)}visitVarStmt(O){let $=null;if(O.initializer!==null)$=this.evaluate(O.initializer);this.environment.define(O.name.lexeme,$)}visitBlockStmt(O){this.execute_block(O.statements,new w(this.environment))}visitIfStmt(O){if(this.is_truthy(this.evaluate(O.condition)))this.execute(O.thenBranch);else if(O.elseBranch!==null)this.execute(O.elseBranch)}visitGetExpr(O){let $=this.evaluate(O.object);if($ instanceof j)return $.get(O.name);throw q.report(new SyntaxError("Only instances have properties."))}visitSetExpr(O){let $=this.evaluate(O.object);if(!($ instanceof j))throw q.report(new SyntaxError("Only instances have fields."));let Q=this.evaluate(O.value);return $.set(O.name,Q),Q}visitSuperExpr(O){let $=this.locals.get(O),Q=this.environment.get_at($,"super"),W=this.environment.get_at($-1,"this"),H=Q.find_method(O.method.lexeme);if(H===null)throw q.report(new SyntaxError(`Undefined property '${O.method.lexeme}'.`));return H.bind(W)}}class DO{tokens;current;constructor(O){this.tokens=O,this.current=0}reset_parser(){this.current=0,this.tokens=[]}set_tokens(O){this.tokens=O}parse(){const O=[];while(!this.is_at_end())try{O.push(this.declaration())}catch($){if($ instanceof Z)throw q.report($);this.synchronize()}return O}class_declaration(){let O=this.consume(U.IDENTIFIER,"Expect class name."),$=null;if(this.match(U.LESS))this.consume(U.IDENTIFIER,"Expect superclass name."),$=new S(this.previous());this.consume(U.LEFT_BRACE,"Expect '{' before class body.");let Q=[];while(!this.check(U.RIGHT_BRACE)&&!this.is_at_end())Q.push(this.function_declaration("method"));return this.consume(U.RIGHT_BRACE,"Expect '}' after class body."),new o(O,$,Q)}function_declaration(O){let $=this.consume(U.IDENTIFIER,`Expect ${O} name.`);this.consume(U.LEFT_PAREN,`Expect '(' after ${O} name.`);const Q=[];if(!this.check(U.RIGHT_PAREN))do{if(Q.length>=255)q.report(new Z(this.peek(),"Cannot have more than 255 parameters."));Q.push(this.consume(U.IDENTIFIER,"Expect parameter name."))}while(this.match(U.COMMA));this.consume(U.RIGHT_PAREN,"Expect ')' after parameters."),this.consume(U.LEFT_BRACE,`Expect '{' before ${O} body.`);const W=this.block();return new T($,Q,W)}declaration(){if(this.match(U.CLASS))return this.class_declaration();if(this.match(U.FUN))return this.function_declaration("function");if(this.match(U.VAR))return this.var_declaration();return this.statement()}var_declaration(){const O=this.consume(U.IDENTIFIER,"Expect variable name.");let $=null;if(this.match(U.EQUAL))$=this.expression();return this.consume(U.SEMICOLON,"Expect ';' after variable declaration."),new s(O,$)}block(){const O=[];while(!this.check(U.RIGHT_BRACE)&&!this.is_at_end())O.push(this.declaration());return this.consume(U.RIGHT_BRACE,"Expect '}' after block."),O}statement(){if(this.match(U.LEFT_BRACE))return new f(this.block());if(this.match(U.IF))return this.if_statement();if(this.match(U.PRINT))return this.print_statement();if(this.match(U.RETURN))return this.return_statement();if(this.match(U.WHILE))return this.while_statement();if(this.match(U.FOR))return this.for_statement();return this.expression_statement()}for_statement(){this.consume(U.LEFT_PAREN,"Expect '(' after 'for'.");let O;if(this.match(U.SEMICOLON))O=null;else if(this.match(U.VAR))O=this.var_declaration();else O=this.expression_statement();let $=null;if(!this.check(U.SEMICOLON))$=this.expression();this.consume(U.SEMICOLON,"Expect ';' after loop condition.");let Q=null;if(!this.check(U.RIGHT_PAREN))Q=this.expression();this.consume(U.RIGHT_PAREN,"Expect ')' after for clauses.");let W=this.statement();if(Q!==null)W=new f([W,new h(Q)]);if($===null)$=new N(!0);if(W=new b($,W),O!==null)W=new f([O,W]);return W}return_statement(){let O=this.previous(),$=null;if(!this.check(U.SEMICOLON))$=this.expression();return this.consume(U.SEMICOLON,"Expect ';' after return value."),new l(O,$)}while_statement(){this.consume(U.LEFT_PAREN,"Expect '(' after 'while'.");const O=this.expression();this.consume(U.RIGHT_PAREN,"Expect ')' after condition.");const $=this.statement();return new b(O,$)}if_statement(){this.consume(U.LEFT_PAREN,"Expect '(' after 'if'.");const O=this.expression();this.consume(U.RIGHT_PAREN,"Expect ')' after if condition.");const $=this.statement();let Q=null;if(this.match(U.ELSE))Q=this.statement();return new a(O,$,Q)}print_statement(){let O=this.expression();return this.consume(U.SEMICOLON,"Expect ';' after value."),new i(O)}expression_statement(){const O=this.expression();return this.consume(U.SEMICOLON,"Expect ';' after expression."),new h(O)}equality(){let O=this.comparison();while(this.match(U.BANG_EQUAL,U.EQUAL_EQUAL)){let $=this.previous(),Q=this.comparison();O=new F(O,$,Q)}return O}comparison(){let O=this.term();while(this.match(U.GREATER,U.GREATER_EQUAL,U.LESS,U.LESS_EQUAL)){let $=this.previous(),Q=this.term();O=new F(O,$,Q)}return O}term(){let O=this.factor();while(this.match(U.MINUS,U.PLUS)){let $=this.previous(),Q=this.factor();O=new F(O,$,Q)}return O}factor(){let O=this.unary();while(this.match(U.SLASH,U.STAR)){let $=this.previous(),Q=this.unary();O=new F(O,$,Q)}return O}call(){let O=this.primary();while(!0)if(this.match(U.LEFT_PAREN))O=this.finish_call(O);else if(this.match(U.DOT)){const $=this.consume(U.IDENTIFIER,"Expect property name after '.'.");O=new v(O,$)}else break;return O}finish_call(O){let $=[];if(!this.check(U.RIGHT_PAREN))do{if($.length>=255)return q.report(new Z(this.peek(),"Can't have more than 255 arguments."));$.push(this.expression())}while(this.match(U.COMMA));let Q=this.consume(U.RIGHT_PAREN,"Expect ')' after arguments.");return new $O(O,Q,$)}unary(){if(this.match(U.BANG,U.MINUS)){let O=this.previous(),$=this.unary();return new t(O,$)}return this.call()}primary(){if(this.match(U.FALSE))return new N(!1);if(this.match(U.TRUE))return new N(!0);if(this.match(U.NIL))return new N(null);if(this.match(U.THIS))return new r(this.previous());if(this.match(U.SUPER)){let O=this.previous();this.consume(U.DOT,"Expect '.' after 'super'.");let $=this.consume(U.IDENTIFIER,"Expect superclass method name.");return new p(O,$)}if(this.match(U.NUMBER,U.STRING))return new N(this.previous().literal);if(this.match(U.LEFT_PAREN)){let O=this.expression();return this.consume(U.RIGHT_PAREN,"Expect ')' after expression."),new e(O)}if(this.match(U.IDENTIFIER))return new S(this.previous());return q.report(new Z(this.peek(),"Expect expression."))}expression(){return this.assignment()}assignment(){let O=this.or();if(this.match(U.EQUAL)){let $=this.previous(),Q=this.assignment();if(O instanceof S){let W=O.name;return new OO(W,Q)}else if(O instanceof v){let W=O;return new n(W.object,W.name,Q)}q.report(new Z($,"Invalid assignment target."))}return O}or(){let O=this.and();while(this.match(U.OR)){let $=this.previous(),Q=this.and();O=new u(O,$,Q)}return O}and(){let O=this.equality();while(this.match(U.AND)){let $=this.previous(),Q=this.equality();O=new u(O,$,Q)}return O}consume(O,$){if(this.check(O))return this.advance();return q.report(new Z(this.peek(),$))}match(...O){for(let $ of O)if(this.check($))return this.advance(),!0;return!1}check(O){if(this.is_at_end())return!1;return this.peek().type===O}advance(){if(!this.is_at_end())this.current++;return this.previous()}previous(){return this.tokens[this.current-1]}peek(){return this.tokens[this.current]}is_at_end(){return this.peek().type==="EOF"}synchronize(){this.advance();while(this.is_at_end()){if(this.previous().type===U.SEMICOLON)return;switch(this.peek().type){case U.CLASS:case U.FUN:case U.VAR:case U.FOR:case U.IF:case U.WHILE:case U.PRINT:case U.RETURN:return}this.advance()}}}var V;(function(H){H["None"]="None";H["Function"]="Function";H["Initializer"]="Initializer";H["Method"]="Method"})(V||(V={}));var M;(function(W){W["None"]="None";W["Class"]="Class";W["SubClass"]="SubClass"})(M||(M={}));class EO extends Array{constructor(){super(...arguments)}is_empty(){return this.length<1}peek(){return this[this.length-1]}}class HO{O;scopes=new EO;currentFunction=V.None;currentClass=M.None;constructor(O){this.interpreter=O;this.interpreter=O}resolve(O){if(O instanceof Array)O.forEach(($)=>this.resolve($));else O.accept(this)}resolve_local(O,$){for(let Q=this.scopes.length-1;Q>=0;Q--)if(this.scopes[Q].has($.lexeme)){this.interpreter.resolve(O,this.scopes.length-1-Q);return}}begin_scope(){this.scopes.push(new Map)}end_scope(){this.scopes.pop()}declare(O){if(this.scopes.is_empty())return;this.scopes.peek().set(O.lexeme,!1)}define(O){if(this.scopes.is_empty())return;this.scopes.peek().set(O.lexeme,!0)}resolve_function(O,$){const Q=this.currentFunction;this.currentFunction=$,this.begin_scope(),O.params.forEach((W)=>{this.declare(W),this.define(W)}),this.resolve(O.body),this.end_scope(),this.currentFunction=Q}visitClassStmt(O){const $=this.currentClass;if(this.currentClass=M.Class,this.declare(O.name),this.define(O.name),O.superclass!==null)if(O.name.lexeme===O.superclass.name.lexeme)q.report(new SyntaxError("A class can't inherit from itself."));else this.currentClass=M.SubClass,this.resolve(O.superclass),this.begin_scope(),this.scopes.peek().set("super",!0);this.begin_scope(),this.scopes.peek().set("this",!0);for(let Q of O.methods){let W=V.Method;if(Q.name.lexeme==="init")W=V.Initializer;this.resolve_function(Q,W)}if(this.end_scope(),O.superclass!==null)this.end_scope();this.currentClass=$}visitBlockStmt(O){this.begin_scope(),this.resolve(O.statements),this.end_scope()}visitVarStmt(O){if(this.declare(O.name),O.initializer!==null)this.resolve(O.initializer);this.define(O.name)}visitVariableExpr(O){if(!this.scopes.is_empty()&&this.scopes.peek().get(O.name.lexeme)===!1)q.report(new P(O.name,"Cannot read local variable in its own initializer."));this.resolve_local(O,O.name)}visitAssignExpr(O){this.resolve(O.value),this.resolve_local(O,O.name)}visitSuperExpr(O){if(this.currentClass===M.None)q.report(new P(O.keyword,"Cannot use 'super' outside of a class."));else if(this.currentClass!==M.SubClass)q.report(new P(O.keyword,"Cannot use 'super' in a class with no superclass."));this.resolve_local(O,O.keyword)}visitFunctionStmt(O){this.declare(O.name),this.define(O.name),this.resolve_function(O,V.Function)}visitExpressionStmt(O){this.resolve(O.expression)}visitIfStmt(O){if(this.resolve(O.condition),this.resolve(O.thenBranch),O.elseBranch!==null)this.resolve(O.elseBranch)}visitPrintStmt(O){this.resolve(O.expression)}visitReturnStmt(O){if(O.value!==null){if(this.currentFunction===V.Initializer)q.report(new P(O.keyword,"Cannot return a value from an initializer."));if(this.currentFunction===V.None)q.report(new P(O.keyword,"Cannot return from top-level code."));this.resolve(O.value)}}visitWhileStmt(O){this.resolve(O.condition),this.resolve(O.body)}visitForStmt(O){if(O.initializer!==null)this.resolve(O.initializer);if(O.condition!==null)this.resolve(O.condition);if(O.increment!==null)this.resolve(O.increment)}visitBinaryExpr(O){this.resolve(O.left),this.resolve(O.right)}visitCallExpr(O){this.resolve(O.callee),O.args.forEach(($)=>this.resolve($))}visitGroupingExpr(O){this.resolve(O.expression)}visitLiteralExpr(O){}visitUnaryExpr(O){this.resolve(O.right)}visitLogicalExpr(O){this.resolve(O.left),this.resolve(O.right)}visitSetExpr(O){this.resolve(O.value),this.resolve(O.object)}visitGetExpr(O){this.resolve(O.object)}visitThisExpr(O){if(this.currentClass===M.None){q.report(new P(O.keyword,"Cannot use 'this' outside of a class."));return}this.resolve_local(O,O.keyword)}}class g{type;lexeme;literal;line;constructor(O,$,Q,W){this.type=O,this.lexeme=$,this.literal=Q,this.line=W}to_string(){return`${this.type} ${this.lexeme} ${this.literal}`}}class qO{logger=new m;tokens;source;current=0;start=0;line=1;constructor(){this.source="",this.tokens=[],this.current=0,this.start=0,this.line=1}add_source(O){this.source+=O,this.current=0,this.start=0,this.line=1}set_source(O){this.source=O}reset_scanner(){this.source="",this.current=0,this.start=0,this.line=1}scan_tokens(){while(!this.is_end())this.start=this.current,this.scan();this.tokens.push(new g(U.EOF,"",null,this.line))}is_end(){return this.current>=this.source.length}advance(){return this.source.charAt(this.current++)}match(O){if(this.is_end())return!1;if(this.source.charAt(this.current)!==O)return!1;return this.current++,!0}add_token(O,$){let Q=this.source.substring(this.start,this.current),W=new g(O,Q,$,this.line);this.tokens.push(W)}peek(){return this.source.charAt(this.current)}current_char(){return this.source.charAt(this.current-1)}is_digit(O){return O>="0"&&O<="9"}is_alpha(O){return O>="a"&&O<="z"||O>="A"&&O<="Z"||O==="_"}is_alpha_numeric(O){return this.is_alpha(O)||this.is_digit(O)}identifier(){while(this.is_alpha_numeric(this.peek()))this.advance();let O=this.source.substring(this.start,this.current);const $=AO[O];if($!==void 0)this.add_token($,null);else this.add_token(U.IDENTIFIER,null)}string(){while(this.peek()!=='"'&&!this.is_end()){if(this.peek()==="\n")this.line++;this.advance()}if(this.is_end())q.report(new Z(null,"Unterminated string.at line "+this.line+" column "+this.current+""));this.advance();let O=this.source.substring(this.start+1,this.current-1);this.add_token(U.STRING,O)}number(){while(this.is_digit(this.peek()))this.advance();if(this.peek()==="."&&this.is_digit(this.peek()))this.advance();let O=this.source.substring(this.start,this.current),$=parseFloat(O);this.add_token(U.NUMBER,$)}scan(){let O=this.advance();switch(O){case"{":this.add_token(U.LEFT_BRACE,null);break;case"}":this.add_token(U.RIGHT_BRACE,null);break;case"(":this.add_token(U.LEFT_PAREN,null);break;case")":this.add_token(U.RIGHT_PAREN,null);break;case"\u2795":case"+":this.add_token(U.PLUS,null);break;case"\u2796":case"-":this.add_token(U.MINUS,null);break;case"\u2716":case"\u274C":case"*":this.add_token(U.STAR,null);break;case"\u2797":case"/":if(this.match("/"))while(this.peek()!="\n"&&!this.is_end())this.advance();else this.add_token(U.SLASH,null);break;case"\u267B":case"%":this.add_token(U.MODULO,null);break;case"\u2714":this.add_token(U.EQUAL_EQUAL,null);break;case"=":this.add_token(this.match("=")?U.EQUAL_EQUAL:U.EQUAL,null);break;case"o":if(this.match("r"))this.add_token(U.OR,null);break;case",":this.add_token(U.COMMA,null);break;case".":this.add_token(U.DOT,null);break;case"\u2757":this.add_token(U.BANG_EQUAL,null);break;case"!":this.add_token(this.match("=")?U.BANG_EQUAL:U.BANG,null);break;case"\u2B05":this.add_token(U.LESS_EQUAL,null);break;case"<":this.add_token(this.match("=")?U.LESS_EQUAL:U.LESS,null);break;case"\u27A1":this.add_token(U.GREATER_EQUAL,null);break;case">":this.add_token(this.match("=")?U.GREATER_EQUAL:U.GREATER,null);break;case"\n":this.line++;break;case"\t":break;case'"':this.string();break;case" ":case"\r":break;case";":this.add_token(U.SEMICOLON,null);break;default:if(this.is_digit(O))this.number();else if(this.is_alpha(O))this.identifier();else q.report(new Z(null,"Unexpected character."));break}}get_tokens(){return this.tokens}print_tokens(){this.logger.info(this.tokens)}}class GO{interpreter;resolver;astPrinter;parser;scanner;MODE;constructor(){this.scanner=new qO,this.interpreter=new WO,this.resolver=new HO(this.interpreter),this.parser=new DO([]),this.astPrinter=new QO,Bun.argv[2]===void 0?this.MODE="REPL":this.MODE="FILE"}run(){if(this.MODE==="FILE")IO((O)=>{this.scanner.set_source(O),this.scanner.scan_tokens();const $=this.scanner.get_tokens();this.parser.set_tokens($);const Q=this.parser.parse();this.resolver.resolve(Q),this.print_ast(Q),console.log(L.blue("                                                 ")),console.log(L.blue("================      Compiled Output       ================")),console.log(L.blue("                                                 ")),this.interpreter.interpret(Q)});else console.log("REPL is still in progress\n"),console.log("Usage: beer [script]")}print_ast(O){console.log(L.cyan("================      AST       ================")),console.log(L.cyan("                                                 ")),this.astPrinter.print_ast(O)}}var dO=new GO;dO.run();
